name: Build
on: [push]
jobs:
    build:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: recursive

            - name: Setup Python
              uses: actions/setup-python@v2
              with:
                  python-version: "3.9"

            - name: Install pipenv
              run: |
                  python -m pip install --upgrade pipenv wheel

            - id: cache-pipenv
              uses: actions/cache@v1
              with:
                  path: ~/.local/share/virtualenvs
                  key: ${{ runner.os }}-pipenv-${{ hashFiles('**/Pipfile.lock') }}

            - name: Install dependencies
              if: steps.cache-pipenv.outputs.cache-hit != 'true'
              run: |
                  pipenv install --deploy --dev

            - id: tagName
              if: startsWith(github.ref, 'refs/tags/v')
              uses: olegtarasov/get-tag@v2.1

            - id: version
              if: startsWith(github.ref, 'refs/tags/v')
              uses: actions-ecosystem/action-regex-match@v2
              with:
                  text: ${{ steps.tagName.outputs.tag }}
                  regex: '(\d+\.\d+\.\d+)'

            - name: Generate metadata
              if: startsWith(github.ref, 'refs/tags/v')
              run: |
                pipenv run generate-version-file --version ${{ steps.version.outputs.group1 }}

            - name: Build executable
              run: |
                  pipenv run build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v2
              with:
                  path: dist
                  name: fredboard-win64

    release:
        runs-on: windows-latest
        needs: build
        if: startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Download build artifacts
              uses: actions/download-artifact@v2
              with:
                  path: dist
                  name: fredboard-win64

            - id: tagName
              uses: olegtarasov/get-tag@v2.1

            - name: Create release
              uses: marvinpinto/action-automatic-releases@latest
              with:
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  prerelease: false
                  title: "Fredboard ${{ steps.tagName.outputs.tag }}"
                  files: |
                      dist/*

